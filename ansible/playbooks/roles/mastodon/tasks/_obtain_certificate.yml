---

- name: Check that ssl certificate exists
  stat:
    path: "/etc/letsencrypt/live/{{ domain_name }}"
  register: mastodon_certificate
  tags: mastodon

- name: Add nginx config
  when: not mastodon_certificate.stat.exists
  template:
    src: mastodon.conf.j2
    dest: /etc/nginx/conf.d/mastodon.conf
    validate: bash -c 'nginx -t -c /dev/stdin <<< "events {worker_connections 1;} http { include %s; }"'
  tags: mastodon

- name: Reload nginx
  when: not is_docker
  systemd:
    name: nginx
    state: reloaded
  tags: mastodon

- name: Obtain SSL certificate
  when: not skip_letsencrypt and not is_test
  shell: "./certbot-auto certonly --non-interactive --agree-tos --webroot --domain {{ domain_name }} --email {{ email }} --webroot-path /home/{{ user_name }}/live/public/"
  args:
    chdir: "{{ letsencrypt_certbot_path }}"
    creates: "/etc/letsencrypt/live/{{ domain_name }}"
  tags: mastodon

- name: Remove comment out of mastodon.conf
  when: not skip_letsencrypt
  replace:
    path: /etc/nginx/conf.d/mastodon.conf
    regexp: '^#(\s+)ssl_certificate(.*)$'
    replace: '\1ssl_certificate\2'
  notify:
    - Reload nginx
  tags: mastodon
